<!DOCTYPE html>
<html>
<head>
    <title>Dynamic Pricing Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        h1 {
            color: #333;
        }
        p {
            margin-bottom: 10px;
        }
        input[type="number"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        button {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            background-color: #007bff;
            color: #fff;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #plot-container {
            margin-top: 20px;
        }
        #python-code-container {
            margin-top: 20px;
        }
        #python-code-textarea {
            width: 100%;
            height: 200px; /* Adjust the height as needed */
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        #rolling-value-container {
            background-color: #f9f9f9;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>Dynamic Pricing Game</h1>
    <div id="introduction">
        <p>Welcome to the Dynamic Pricing Game!</p>
        <p>
            This web app allows you to simulate dynamic pricing strategies in a controlled environment. With this tool, you can set prices for offering customers, observe how the market reacts to those prices, and track the cumulative rewards over time.
        </p>
        <p>
            The app provides an interactive interface where you can adjust the pricing strategy in real-time, visualize the impact of different price points on customer behavior, and analyze the cumulative rewards generated by your pricing decisions.
        </p>
        <p>
            Whether you're studying pricing strategies, experimenting with dynamic pricing models, or simply exploring the dynamics of supply and demand, the Dynamic Pricing Game offers a hands-on experience to deepen your understanding of pricing dynamics in various market scenarios.
        </p>
    </div>
    <input type="number" id="mean-input" step="1" value="0">
    <button id="set-mean-button">Set Price</button>
    <button id="stop-button">Stop</button>
    <button id="reset-button">Reset</button>
    <button id="start-button">Start</button>
    <div id="rolling-value-container">Rolling Value: <span id="rolling-value">0.00</span></div>
    <div id="plot-container"></div>
    <div id="python-code-container">
        <p>Write Python code to update pricing strategy. Please call your function "set_price".</p>
        <textarea id="python-code-textarea" placeholder="Enter Python code here"></textarea>
        <button id="apply-code-button">Apply Code</button>
    </div>
    <div id="python-syntax-error"></div>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/mode/python/python.min.js"></script>
    <script>
        var meanInput = document.getElementById("mean-input");
        var setMeanButton = document.getElementById("set-mean-button");
        var stopButton = document.getElementById("stop-button");
        var resetButton = document.getElementById("reset-button");
        var startButton = document.getElementById("start-button");
        var plotContainer = document.getElementById("plot-container");
        var applyCodeButton = document.getElementById("apply-code-button");
        var isRunningCodeApply = false; // Flag to track whether codeApply is running

        var newMean = 0//parseFloat(meanInput.value);

        var plot = null;
        var stop = false;
        var start = false;
        var xData = [];
        var yData = [];
        var cumulativeYData = [];
        var prices = []; // List to keep track of prices being set

        var editor = CodeMirror.fromTextArea(document.getElementById('python-code-textarea'), {
            mode: 'python',
            lineNumbers: true,
        });

        function createEmptyPlot() {
            plot = Plotly.newPlot("plot-container", [{
                x: [],
                y: [],
                type: "scatter",
                mode: "lines+points",
                name: "Gaussian Data"
            }], {
                xaxis: { title: "Iteration" },
                yaxis: { title: "Observed Reward", range: [0, 100] }
            });
        }

        function updateRollingValue() {
            rollingValue = cumulativeYData.length > 0 ? cumulativeYData[cumulativeYData.length - 1] : 0;
            $("#rolling-value-container").text("Rolling Value: " + rollingValue.toFixed(2));
        }

        setMeanButton.addEventListener("click", function() {
            isRunningCodeApply = false;
            console.log("Set Price"); 
        });

        applyCodeButton.addEventListener("click", function () {
            isRunningCodeApply = true;
            console.log("Set Code")
        });

        createEmptyPlot();

        function updatePlot() {

            if (stop || !start) {
                return;
            }

            if (isRunningCodeApply == true) {
                console.log("applying code")
                var code = decodeURIComponent(editor.getValue());
                console.log(code)
                // Send AJAX request to call the function
                $.ajax({
                    url: "/execute_python_code",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ code: code, xData: xData, yData: yData}),
                    success: function(response) {
                        if (response.result) {
                            console.log("Function called successfully. Result:", response.result);
                            newMean = parseFloat(response.result); // Update newMean with the result of codeApply
                            prices.push(newMean);
                        } else {
                            console.error("Error calling function:", response.error);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("AJAX error:", error);
                    }
                });
            } else if (isRunningCodeApply == false) {
                console.log("Using manual input price")
                newMean = parseFloat(meanInput.value);
                prices.push(newMean); // Add the price to the list
            }

            updateRollingValue();

            $.get("/update_plot?mean_value=" + newMean, function(data) {
                xData.push(xData.length);
                yData.push(data.y);
                cumulativeYData.push(yData.reduce((a, b) => a + b, 0));

                if (xData.length > 500) {
                    xData.shift();
                    yData.shift();
                }
                if (plot) {
            Plotly.update("plot-container", {
                x: [xData],
                y: [yData],
            });
            } else {
                plot = Plotly.newPlot("plot-container", [{
                    x: xData,
                    y: yData,
                    type: "scatter",
                    mode: "lines+points",
                    name: "Gaussian Data"
                }], {
                    xaxis: { title: "Iteration" },
                    yaxis: { title: "Observed Reward", range: [0,100] }
                });
            }
            });
        }

        stopButton.addEventListener("click", function() {
            stop = true;
        });

        startButton.addEventListener("click", function() {
            stop = false;
            start = true;
            updatePlot();
        });

        resetButton.addEventListener("click", function() {
            xData = [];
            yData = [];
            start = false;
            plot = null;
            prices = []; // Reset the list of prices
        });

        setInterval(updatePlot, 1000);
    </script>
</body>
</html>
